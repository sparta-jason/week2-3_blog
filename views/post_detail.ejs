<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />

    <!-- Bulma -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />

    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU"
      crossorigin="anonymous"
    />
    <!-- JavaScript Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
      crossorigin="anonymous"
    ></script>

    <!-- Font Awesome CSS -->
    <link
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
      integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js"></script>

    <link rel="stylesheet" type="text/css" href="static/style.css" />

    <title>제이슨의 게시판 | 게시글</title>

    <style></style>

    <script>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const postsId = urlParams.get("postsId");

      $(document).ready(function() {
        get_detail();
        get_replies();
      });

      // get_detail 함수 내에서 할당되고 move_edit함수에서 인자로 사용
      // > 수정화면 진입 시 동일 포스트 보여주기 위함
      let postsId_toEdit = "";

      function get_detail() {
        $.ajax({
          type: "GET",
          url: `/api/posts/${postsId}`,
          data: {},
          error: function(xhr, status, error) {
            if (status == 404) {
              alert("존재하지 않는 포스팅입니다.");
            }
            window.location.href = "/";
          },
          success: function(response) {
            if (response.detail == null) {
              alert("해당 포스팅이 존재하지 않습니다.")
              window.location.href='/'
            }else{
              let postDetail = response.detail;
            let temp_date = postDetail.date;
            temp_date = parseInt(temp_date);

            let date_set = new Date(temp_date);
            let print_date =
              date_set.getFullYear() +
              "년 " +
              ("0" + (date_set.getMonth() + 1)).slice(-2) +
              "월 " +
              ("0" + date_set.getDate()).slice(-2) +
              "일";
            $("#title").text(postDetail.title);
            $("#writer").text(postDetail.writer);
            $("#date").text(print_date);

            //text속성으로 넣을 때, 문자열내 줄바꿈 관련 기호를 <br>태그로 치환한 후 html 형식으로 붙여넣어 br 적용되게 함.
            let contentBr = postDetail.content
            contentBr = contentBr.replace(/(?:\r\n|\r|\n)/g, '<br>');
            $('#content').html(contentBr)

            postsId_toEdit = postDetail.postsId;
            }
            
          }
        });
      }

      //수정하기 클릭 시 실행하여 post_edit페이지로 이동
      function move_edit() {
        let moveTo = "?postsId=" + postsId_toEdit;
        window.location.href = "/post_edit" + moveTo;
      }


      //---댓글 관련 기능---

      function get_replies() {
        $("#replies_box").empty();
        
        $.ajax({
          type: "GET",
          url: `/api/replies/${postsId}`,
          data: {},
          success: function(response) {
            console.log(response);
            let replies = response["replies"];
            for (let i = 0; i < replies.length; i++) {
              make_card(replies[i])
              // if (replies[i].nickname == response.chk_nickname) {
              //   make_authcard(replies[i])
              // }else{
              //   make_card(replies[i]);
              // }
              
            }
          }
        });
      }
      
      function make_authcard(item) {
        let htmlTemp = `
                      <div class="card" id="reply_card">
                        <div class="card-content">
                          <div class="content">
                            작성자 : ${item.nickname} 
                            <button>수정</button>
                            <button>삭제</button><br>
                            ${item.reply_content}
                          </div>
                        </div>
                      </div>
                            `;
        $("#replies_box").append(htmlTemp);
      }

      function make_card(item) {
        let htmlTemp = `
                      <div class="card" id="reply_card">
                        <div class="card-content">
                          <div class="content">
                            작성자 : ${item.nickname} <br>
                            ${item.reply_content}
                          </div>
                        </div>
                      </div>
                            `;
        $("#replies_box").append(htmlTemp);
      }

      //댓글작성
      function create_reply() {
        let reply_content = $("#reply_input").val();

        $.ajax({
          type: "POST",
          url: `/api/reply_create`,
          headers: {
                  authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
          data: {
            reply_content,
            postsId,
          },
          success: function(response) {
            window.location.reload();
            alert(response["result"]);
          },
          error: function (error) {
            customAlert(error.responseJSON.errorMessage);
          },
        });
      }

      function customAlert(text, confirmCallback) {
        $("#alertText").text(text);
        $("#alertModal").modal("show");
        if (confirmCallback) {
          $("#alertModal .btn-confirm").click(confirmCallback);
        }
      }
    </script>
  </head>
  <body>
    <nav class="navbar navbar-light">
      <span class="container-fluid">
        <a id="nav-title" class="navbar-brand" href="/">제이슨의 게시판</a>
      </span>
    </nav>

    <div id="detail_wrap">
      <div class="detail_content is-medium">
        <h1 id="title"></h1>
        <span id="top_set">
          <span id="writer"></span> ｜ <span id="date"></span> ｜
          <span id="edit_btn" onclick="move_edit()">수정</span>
        </span>
        <hr />
        <p id="content"></p>
        <hr />
      </div>
      <div id="tolist_wrap">
        <a href="/"><button class="button" id="tolist_btn">목록으로</button></a>
      </div>
    </div>

    <div class="card" id="reply_makeBox">
      <div class="card-content">
        <div class="control">
          <input class="input" id="reply_input" type="text" placeholder="여러분의 댓글을 입력해주세요.">
        </div>
        <button onclick="create_reply()">댓글작성</button>
      </div>
    </div>

    <div id="replies_box">
      <div class="card" id="reply_card">
        <div class="card-content">
          <div class="content">
            Lorem ipsum leo risus, porta ac consectetur ac, vestibulum at eros. Donec id elit non mi porta gravida at eget metus. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Cras mattis consectetur purus sit amet fermentum.
          </div>
        </div>
      </div>
  
      <div class="card" id="reply_card">
        <div class="card-content">
          <div class="content">
            Lorem ipsum leo risus, porta ac consectetur ac, vestibulum at eros. Donec id elit non mi porta gravida at eget metus. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Cras mattis consectetur purus sit amet fermentum.
          </div>
        </div>
      </div>
  
      <div class="card" id="reply_card">
        <div class="card-content">
          <div class="content">
            Lorem ipsum leo risus, porta ac consectetur ac, vestibulum at eros. Donec id elit non mi porta gravida at eget metus. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Cras mattis consectetur purus sit amet fermentum.
          </div>
        </div>
      </div>
    </div>


    <!-- modal -->
    <div
      class="modal text-left"
      id="alertModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="alertModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertModalLabel">알림</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="alertText">
            정말로 로그아웃 하시겠습니까?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-sparta btn-confirm"
              data-dismiss="modal"
            >
              확인
            </button>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>
